<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petrol Cost Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Keep all your original styles here */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
               background-color: #121212; line-height: 1.6; padding: 20px; color: #e0e0e0; }
        .container { max-width: 500px; margin: 0 auto; background-color: #1e2a3a;
                    border-radius: 12px; box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
                    padding: 25px; border: 1px solid #2c3e50; }
        /* ... rest of your original CSS ... */
    </style>
</head>
<body>
    <div id="auth-container" class="container">
        <h1>Petrol Cost Tracker</h1>
        <div id="login-form">
            <h2>Login</h2>
            <div id="login-error" class="error-message hidden"></div>
            <div class="input-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" placeholder="Your email">
            </div>
            <div class="input-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="Your password">
            </div>
            <button class="btn btn-login" onclick="login()">Login</button>
            <p style="text-align: center;">Don't have an account? <a href="#" onclick="showSignup()">Sign up</a></p>
        </div>

        <div id="signup-form" class="hidden">
            <h2>Sign Up</h2>
            <div id="signup-error" class="error-message hidden"></div>
            <div class="input-group">
                <label for="signup-email">Email</label>
                <input type="email" id="signup-email" placeholder="Your email">
            </div>
            <div class="input-group">
                <label for="signup-username">Username</label>
                <input type="text" id="signup-username" placeholder="Choose a username">
            </div>
            <div class="input-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" placeholder="Choose a password (min 6 chars)">
            </div>
            <button class="btn btn-signup" onclick="signup()">Sign Up</button>
            <p style="text-align: center;">Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
        </div>
    </div>

    <div id="app-container" class="container hidden">
        <div class="user-info">
            Logged in as: <span id="current-username"></span>
            <span id="admin-badge" class="admin-badge hidden">ADMIN</span>
            <span class="logout-btn" onclick="logout()">Logout</span>
        </div>
        <h1>Petrol Cost Tracker</h1>

        <div class="input-group">
            <label for="distance">Distance (km)</label>
            <input type="number" id="distance" placeholder="Enter kilometers">
        </div>

        <div class="input-group">
            <label for="petrolPrice">Petrol Price (R/L)</label>
            <input type="number" id="petrolPrice" placeholder="Price per liter">
        </div>

        <button class="btn btn-calculate" onclick="calculatePetrolCost()">Calculate Cost</button>

        <div id="result"></div>

        <div id="history">
            <h2>Trip History</h2>
            <div id="loading" class="loading hidden">Loading...</div>
            <div id="trips"></div>
            <div id="total" class="total-amount"></div>
            <button class="btn btn-clear" onclick="clearHistory()">Clear My History</button>
            <button id="admin-clear-all" class="btn btn-clear hidden" onclick="clearAllHistory()">Clear All History (Admin)</button>
        </div>
    </div>

    <script>
        // Supabase configuration - REPLACE WITH YOUR ACTUAL VALUES
        const SUPABASE_URL = 'https://mfbirfnnwuqcimaqcade.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mYmlyZm5ud3VxY2ltYXFjYWRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5MDg0MTYsImV4cCI6MjA1ODQ4NDQxNn0.RffpqW0JElfopAp-aF5xI2WDsKCNjeFO5w_BLWNZqhI';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // App state
        let currentUser = null;
        let isAdmin = false;

        // DOM elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');

        // Initialize auth state listener
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session?.user) {
                await fetchUserProfile(session.user.id);
                showApp();
            } else {
                currentUser = null;
                isAdmin = false;
                showLogin();
            }
        });

        // Auth functions
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            
            if (error) {
                showError('login-error', error.message);
            }
        }

        async function signup() {
            const email = document.getElementById('signup-email').value;
            const username = document.getElementById('signup-username').value;
            const password = document.getElementById('signup-password').value;
            
            // Basic validation
            if (password.length < 6) {
                showError('signup-error', 'Password must be at least 6 characters');
                return;
            }

            // Create auth user
            const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });
            if (authError) {
                showError('signup-error', authError.message);
                return;
            }

            // Create user profile
            const { error: profileError } = await supabase
                .from('app_users')
                .insert([{ 
                    auth_id: authData.user.id, 
                    username,
                    is_admin: username.toLowerCase() === 'admin'  // Auto-set admin if username is Admin
                }]);

            if (profileError) {
                showError('signup-error', profileError.message);
                return;
            }

            // Show success and redirect to login
            document.getElementById('signup-error').classList.add('hidden');
            document.getElementById('signup-success').textContent = 'Account created! Please login.';
            document.getElementById('signup-success').classList.remove('hidden');
            setTimeout(showLogin, 2000);
        }

        async function logout() {
            await supabase.auth.signOut();
        }

        async function fetchUserProfile(authId) {
            const { data, error } = await supabase
                .from('app_users')
                .select('*')
                .eq('auth_id', authId)
                .single();

            if (data) {
                currentUser = data;
                isAdmin = data.is_admin;
                document.getElementById('current-username').textContent = data.username;
                document.getElementById('admin-badge').classList.toggle('hidden', !isAdmin);
                document.getElementById('admin-clear-all').classList.toggle('hidden', !isAdmin);
            }
        }

        // Trip functions (maintaining your original logic)
        async function calculatePetrolCost() {
            const distance = parseFloat(document.getElementById('distance').value);
            const petrolPrice = parseFloat(document.getElementById('petrolPrice').value);
            const resultElement = document.getElementById('result');

            if (isNaN(distance) || isNaN(petrolPrice) || distance <= 0 || petrolPrice <= 0) {
                resultElement.textContent = 'Please enter valid distance and price';
                resultElement.style.color = '#d32f2f';
                return;
            }

            try {
                const { error } = await supabase
                    .from('trips')
                    .insert([{
                        user_id: currentUser.id,
                        distance,
                        petrol_price: petrolPrice,
                        total_cost: (distance / 11.47) * petrolPrice
                    }]);

                if (error) throw error;

                resultElement.textContent = `Amount Owed: R${((distance / 11.47) * petrolPrice).toFixed(2)}`;
                resultElement.style.color = '#4a6cf7';
                document.getElementById('distance').value = '';
                document.getElementById('petrolPrice').value = '';
                loadTrips();
            } catch (error) {
                resultElement.textContent = 'Error saving trip. Please try again.';
                resultElement.style.color = '#d32f2f';
                console.error('Error saving trip:', error);
            }
        }

        async function loadTrips() {
            const tripsElement = document.getElementById('trips');
            const totalElement = document.getElementById('total');
            const loadingElement = document.getElementById('loading');

            loadingElement.classList.remove('hidden');
            tripsElement.innerHTML = '';

            try {
                let query = supabase
                    .from('trips')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (!isAdmin) {
                    query = query.eq('user_id', currentUser.id);
                }

                const { data: trips, error } = await query;

                if (error) throw error;

                if (!trips || trips.length === 0) {
                    tripsElement.innerHTML = '<div class="history-item">No trips recorded yet</div>';
                    totalElement.textContent = `Total Spent: R0`;
                    return;
                }

                trips.forEach(trip => {
                    const tripElement = document.createElement('div');
                    tripElement.classList.add('history-item');
                    tripElement.innerHTML = `
                        <div>${new Date(trip.created_at).toLocaleDateString()}<br>
                        ${trip.distance} km @ R${trip.petrol_price}/L</div>
                        <div>R${trip.total_cost.toFixed(2)}</div>
                    `;
                    tripsElement.appendChild(tripElement);
                });

                const totalSpend = trips.reduce((sum, trip) => sum + trip.total_cost, 0);
                totalElement.textContent = `Total Spent: R${totalSpend.toFixed(2)}`;
            } catch (error) {
                tripsElement.innerHTML = '<div class="history-item">Error loading trips</div>';
                console.error('Error loading trips:', error);
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        async function clearHistory() {
            if (!confirm('Are you sure you want to delete all your trip history?')) return;

            const { error } = await supabase
                .from('trips')
                .delete()
                .eq('user_id', currentUser.id);

            if (error) {
                alert('Error clearing history. Please try again.');
                console.error('Error clearing history:', error);
            } else {
                loadTrips();
            }
        }

        async function clearAllHistory() {
            if (!isAdmin) return;
            if (!confirm('Are you sure you want to delete ALL trip history?')) return;

            const { error } = await supabase
                .from('trips')
                .delete()
                .neq('id', ''); // Delete all trips

            if (error) {
                alert('Error clearing all history. Please try again.');
                console.error('Error clearing all history:', error);
            } else {
                loadTrips();
            }
        }

        // UI functions
        function showLogin() {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
        }

        function showSignup() {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
        }

        function showApp() {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            loadTrips();
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        // Initialize
        showLogin();
    </script>
</body>
</html>
